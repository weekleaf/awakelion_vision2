/*
                                        ....... ............
                                        ..,]]/@@@@@@@@@]]]..
                            . .....]/@@@@@@@@@@@@@@@@@@@@@@@@@@]........
                            ..\/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\]...
                    ......,@@@@@@@@@@@@@@@@/[[.............*[\@@@@@@@@@@]`......
                    ...,@@@@@@@@@@@@@\@@..... ... ,\]..........@@@/\@@@@@@@@@]..
            ../@\`.....,[[[[\@@@....=@@@....    ..,@@@@@@@]`...@@@@@@\].,[@@@@@@@].........                                                                                 .. .......... ...
            ./@@@@@@\`......=@@@^..,@@@@^...    ...,@@@@@@@@@@@@\]......*`.....[\@@@@\`....                                                                                 ................
         ...=@@@@@@@@@@@@@@@@@@@@@@@@@@@@.....=@\]...\@@@@@@@@@@@@@@@@@\].............[[....                                                                                .................
        .. .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@]...\@@@@^........,[[@@@@@@@@@@@@@]..............                                                                            .......,[\@@@@@]....
        ...=@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`@@@@/.........=@@^.....*[[@@@@@@@`....,@\]......                                                                   ..*=O@@@@@@@@\]]].*......
        ...@@@@@@[[@@@@@@@@@@[\@@@@@@@@@@@@@@@@@@@@/]]].......=@@^....................=@@@@^....                                                                   ..*@@@@@O`\@^,^*@@@^......
        ..=@[...    ,@@@@@@`..=@@@....=@@@..\@@@@/..\@@@@@@@@]/@@\]]]]]]`...@@@].......,@@@@^...                                                                   .=*@@@@@*,@\.,..,@@^......
        ........    .=@@@@\...=@@@....=@@@...@@@@.....\@@@@@@@@@@@@@@@@@@@@`.\@@@@@^....@@@@^.......                                                               .,*@@@/*OOO.,*,[@@@^,.....
                    .=@@@@@...=@@@.. .=@@@...=@@@.......\@@@@@@@@/[[[@@@@@@@\.,@@@@@@...@@@@^...........                                                           .`=@@@@oO.*.*=@^`@@^*.....
                    .=@@@@@...=@@@....=@@@...@@@@..............@@^......,@@@@..,@@@@@@]@@@@@`.@@@\......                                                           .^=@@@`=@/*O..,,@@@*^.....
                    .=@@@@@^. =@@@ ...=@@@...@@@^..............@@^........,@/...=@@@@@@@@@@^..=@@@@`....                                                           .*=@@O/@O@@`/@@@@@@*^.....
                    .@@@@@@^ .=@@@ ...=@@@..=@@@...]]`........,@@*...............@@@@@@@@@/. ..@@@@@^...                                                           ..O@@@@@@@@\@@@@@@O*^.....
        ....    ..../@@@@@@^..=@@@... =@@@. /@@@...=@@@@@@@@@@@@@@@@@@]..........@@@@@@@@/.....,@@@@@...                                                           ..@@@@@@@@O@@@@@@@^=.....
        .\..    ...=@@@@@@@^..=@@@....=@@@..@@@^.....,@@@@@@@@@@@@@@@@@@@......./@@@@@@@`.....=@@@@@@^..                                                           .*@@@@@@@@**@O[O@@^O.....
        .@@.......=@@@@@@@@...@@@@..../@@@.=@@@`    ....[[[[@@@@@@@@@@@@@@`..../@@@@@@@@......@O@@@@@@.=@@@@@@]]]`..............                                ...*=@@@O@@@@**@@**@@*......
        =@@@\. ../@@@@@@@@\],@@@@..../@@@^.=@@@.    ..........@@@...........,@@@@@@@@@@^..../@@O@@@@@@.=@@@@@@@@@@@@@@@@@@]]]...                                ....=@@@*=@@^.,*`.*@@\*......
        .@@@@@@@@@@@@@@@@@@@@@@@@\]/@@@@^..=@@@             .,@@@..... .,O@@@@@[[\@@@@@^...@@@^.@@@@@^.=@@@@@@@@@@@@@@@@@@@@@@@@@@@\]`.............             .. .O@*....*]]O],]/@@,.......
        .\@@@@@@@@@@@@@@@@@@@@[[@@@@@@@@\]`@@@@.            .=@@@ ......,]]]....*@@@@@@@..=@@^.=@@@@@..@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\]......             .. .@@@@@@O@@@O@@@//.........
        .,@@@@@@@@@@@@@@@@@@`,@@@@@@/......\@@@O]]....  ,]]/@@@@@@@@@@@@[......=@@@@@@@@*.=@. .=@@@@^..     ............,[[@@@@@@@@@@@@@@@@@@@@@@]`... .          ...........................
        ..,@@@@@@@@@`......*.[*`[[`........=@@@.........=@@@@@@@@@@@@[.......,@@@@@@@@@@^......@@@@@....    .......... ...........,[[@@@@@@@@@@@@@@@@\`.          ...........................
    ........,[[[............................@@@@]]]@@@@@@@@@@@@@@@[.......,/@@@@@@@@@@@@@`... =@@@@@                .........,]@@@@@@@@@@@@@@@@@@@@@@@@@@@].....    ...,@@\]]]/@@@@@@@@@@]`.....
     ../@@@@@@@@@@@\O@@@@@@@@@@@@@\`......,]/@@@@@@@@/*@@@@@@@@/*]]]]@@@@@@@@@@@[`.@@@@@@^....@@@@@^                ...../@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\..    ...\@@@@@@@@@@@@@@@@@@@@@\`.
....,@@@@@@@@/[[[[\@@@\[@@@@@@@@@@@@@@@@@@@@@@@@@/[../@@@@@/`...............    ...@@@@@@@....@@@@@\                ..]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\`.... ...[@@@@@@@@@@@@@@@@@@@@@`...
...,@@@@@/......................,[@@@@@@@@@@/[......[[[*........... ........    ../@@@@@@@....@@@@@@                ,@@@@@@@@@@[`..=@@@@@@@@@@@@@@@@@@@.[@@@@@@@@@@@]...................,[@@@@@@@@`.
 ..@@@@@/ ..        ........... ...........  ...        ............    ........,@@@@@@@@^....\@@@@@....        .../@@@@@@@@/....,@@@@@@`.......[@@@@@@\...,\@@@@@@@@@@\.......             ,@@@@@@^....
..*@@@@@`...          .........     .......  ...                ....    ....../@@@@@@@@@@.....=@@@@@^...        .=@@@@@@@@/...../@@@@/............\@@@@@^.....,\@@@@@@@@@@\`....            .,@@@@@@. ..
...@@@@@@...        ............... .............................. ......]]@@@@@@@@@@@@@......=@@@@@@...........@@@@@@@@@`....,@@@@@`......     ..,@@@@@@. .    .,\@@@@@@@@@@@@`.............,@@@@@@^...
. .=@@@@@@`.        ......*............]]@@@@@@@@@@@]]]]]]]]]]]]]]@@@@@@@@@@@@@@@@@@@@/.. ..../@@@@@@\........,@@@@@@@@@...../@@@@@`.......     ..,@@@@@@^..    .....[@@@@@@@@@@@@@@]]]`]]]]@@@@@@@@...
    =@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*......./@@@@@@@@^....../@@@@@@@@^.....@@@@@@`....../@@@@@@@@@@@@@@@`..        ....,\@@@@@@@@@@@@@@@@@@@@@@@@@`
    ..\@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/`.......,@@@@@@@@@@@^.../@@@@@@@@@`. ..,@@@@@@`..    =@@@@@@@@@@@@@@@@...        .........[\@@@@@@@@@@@@@@@@@@`..
        .[[[[[[[[[[[[[[[[[[[[[[[[[[@@@@/[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[....    ..@@@@@[\@@@[\@@..[[[[[[[[[[.....=@/[@@[`...... \@@@@@@@@@@@@@[`....                    ...,[[[[@@@[[[.....
        ..........................................  ................................    .............. ................................ ....................                    ...................
*/
#include "ros/ros.h"
#include <iostream>
#include <thread>
#include <opencv2/opencv.hpp>
// #include <QFile>
// #include <QDir>
#include <unistd.h>
#include <ctime>

#include "auto_aim/Settings/Settings.h"
#include "auto_aim/AngleSolver/PnpSolver.h"
#include "auto_aim/Camera/MVVideoCapture.h"
#include "auto_aim/ArmorDetector/ArmorDetector.h"
#include "auto_aim/Gui/Gui.h"
#include "robot_driver/vision_rx_data.h"
#include "robot_driver/vision_tx_data.h"

using namespace std;
using namespace cv;

ros::Publisher vision_pub;
ros::Subscriber vision_sub;
robot_driver::vision_tx_data pc_recv_mesg;
robot_driver::vision_rx_data pc_send_mesg;

void visionCallback(const robot_driver::vision_rx_data::ConstPtr &msg){
    pc_send_mesg.bullet_level = msg->bullet_level;
    pc_send_mesg.direction = msg->direction;
    pc_send_mesg.robot_color = msg->robot_color;
    pc_send_mesg.robot_pitch = msg->robot_pitch;
    pc_send_mesg.robot_yaw = msg->robot_yaw;
    pc_send_mesg.task_mode = msg->task_mode;
    pc_send_mesg.time_stamp = msg->time_stamp;
    pc_send_mesg.visual_valid = msg->visual_valid;
}

void mainProcessing(MainSettings *main_setting, ArmorSettings *armor_setting);

int main(int argc, char *argv[])
{
    //-----------------------------------【类初始化】------------------------------------------
    // brief：初始化类
    //---------------------------------------------------------------------------------------
    
    setlocale(LC_ALL,"");

    ros::init(argc,argv,"auto_aim");
    ros::NodeHandle nh;
    
    vision_pub = nh.advertise<robot_driver::vision_tx_data>("vision_tx_data",1);
    vision_sub = nh.subscribe("/vision_rx_data", 1, visionCallback);MainSettings main_setting(PARAM_OTHER_PATH);

    ArmorSettings armor_setting(PARAM_ARMOR_PATH);
    main_setting.digitClassiferParam();
    mainProcessing(&main_setting, &armor_setting);
    return 0;
}

#ifdef USE_CUTECOM
void openCuteCom()
{
    system("cutecom");
}
#endif // USE_CUTECOM

void mainProcessing(MainSettings *main_setting, ArmorSettings *armor_setting)
{
    //-----------------------------------【类初始化】--------------------------------------------
    // brief：初始化主函数类
    //-----------------------------------------------------------------------------------------
    ArmorDetector armor(armor_setting, main_setting, armor_setting->armor_contours);
    AngleSolver angle_slover(PARAM_CALIBRATION_752, 1);
    GravityCompensateResolve gc = GravityCompensateResolve();

//    armor_kalman a_kalman(0.2f,0.3f,1.f,0.f,0.f);

#ifdef DEBUG_MODE
    DataCollect dc(800, 720);
    std::vector<cv::Scalar> color_list = {cv::Scalar(0, 0, 255),  // 红 pitch角
                                          cv::Scalar(0, 255, 0)}; // 绿 yaw角
    std::vector<float> angle_data = {50, 1};
#endif // DEBUG_MODE

   // long t1 = 0;

    //-----------------------------------【保存视频】--------------------------------------------
    // brief：从配置文件中获取当前序号，序号自增
    //------------------------------------------------------------------------------------------------
    cv::VideoWriter vw_src;
    if (main_setting->debug.b_save_result == true)
    {
        std::ostringstream s_src;

        int n = main_setting->debug.n_save_result;
        main_setting->debug.n_save_result++;
        main_setting->writeOtherParam(PARAM_OTHER_PATH);

        s_src << SAVE_VIDEO_DIR << "sentry_" << "src_" << n << ".avi";

        vw_src.open(s_src.str(),
                    cv::VideoWriter::fourcc('M', 'J', 'P', 'G'),
                    80,
                    cv::Size(SHOW_WIDTH / SHOW_RADIO, SHOW_HEIGHT / SHOW_RADIO),
                    true);
        if (vw_src.isOpened() == false)
        {
            std::cout << "Can't open *.avi file" << std::endl;
            return;
        }
    }
    //---------------------------------【工业相机/视频初始化】-------------------------------------
    // brief：初始化主函数类
    //-----------------------------------------------------------------------------------------
#if (USE_VIDEO == 0)
    std::cout << "MVVideoCapture Init" << std::endl;
    if(-1 == MVVideoCapture::Init())
    {
        std::cout << "MVVideoCapture ERROR!!!" << std::endl;
        return;
    }
    MVVideoCapture::Play();
    MVVideoCapture::SetExposureTime(false, (main_setting->debug.expore_time)*0.7);
    MVVideoCapture::SetLargeResolution(true);
    std::cout << "MVVideoCapture Finished!" << std::endl;
#elif (USE_VIDEO == 1)
    VideoCapture cap(VIDEO_PATH);
    if(!cap.isOpened()){
        std::cout<< "  video path  error "<< std::endl;// check if we succeeded
    }
#endif  // USE_VIDEO

    //--------------------------------------【循环】--------------------------------------------
    // brief：
    //-----------------------------------------------------------------------------------------
    while(ros::ok())
    {
        ros::spinOnce();
        // 设置参数滑动条
#ifdef DEBUG_MODE
        main_setting->setMainParam("主要设置");
#ifdef DEBUG_CAMERA
        main_setting->setCameraParam("camera");

#endif // DEBUG_CAMERA
        double t2 = (double)cv::getTickCount();
#endif // DEBUG_MODE
        
       // angle_slover.setRelationPoseCameraPTZ(main_setting->camera_param.x, main_setting->camera_param.y,main_setting->camera_param.z, main_setting->camera_param.y_offset);
        //t1 = cv::getTickCount();//在代码开始时记录一个时间戳，然后在结束时再次调用该函数并记录一个新的时间戳。通过计算两个时间戳之间的差值（单位为CPU时钟周期），可以得到代码执行的时间。

        cv::Mat src;
#if (USE_VIDEO == 0)
        MVVideoCapture::GetFrame(src);
        if(src.empty())
        {
            std::cout << "Image empty!" << std::endl;
            continue;
        }
        cv::resize(src,src,cv::Size(SHOW_WIDTH,SHOW_HEIGHT));
#elif (USE_VIDEO == 1)
        cap >> src;
        cv::resize(src, src, cv::Size(src.cols * 1, src.rows * 1));
#endif  // USE_VIDEO



#ifdef DEBUG_MODE
        if(main_setting->debug.b_save_pic)
            main_setting->grabImg(src, main_setting->debug.n_key_order, main_setting->debug.f_save_pic_inter * cv::getTickFrequency() / 1000.0);
        if(main_setting->debug.b_show_src)
        {
            cv::namedWindow("src");
            cv::imshow("src", src);
        }
        else
        {
            if(-1 != cv::getWindowProperty("src", 1))
                cv::destroyWindow("src");
        }
#endif  // DUBUG_MODE

////         获取裁判系统敌方装甲板颜色(比赛前切记打开)
//        if(unpack_data->getStm2PcMesg()->stm32_info_data.enemy_color == 1)
//            main_setting->enemy_color = red;
//        else if(unpack_data->getStm2PcMesg()->stm32_info_data.enemy_color == 2)
//            main_setting->enemy_color = blue;

        if(pc_send_mesg.robot_color == 0)
            main_setting->enemy_color = red;
        else if(pc_send_mesg.robot_color == 1)
            main_setting->enemy_color = blue;

////         接收电控发送的模式切换(比赛前切记打开)
//        if(!std::isnan(unpack_data->getStm2PcMesg()->armors_Union.info.task_mode))
//            main_setting->main_mode = unpack_data->getStm2PcMesg()->armors_Union.info.task_mode;
//        std::cout<<"now mode is "<<main_setting->main_mode<<std::endl;
        if(!std::isnan(pc_send_mesg.task_mode))
            main_setting->main_mode = pc_send_mesg.task_mode;

//#ifdef DEBUG_MODE
//        std::cout << "main_mode:          " << unpack_data->getStm2PcMesg()->stm32_info_data.main_mode << std::endl;
//        std::cout << "enemy_color:        " << unpack_data->getStm2PcMesg()->stm32_info_data.enemy_color << std::endl;
//        std::cout << "is_left:            " << unpack_data->getStm2PcMesg()->stm32_info_data.is_left << std::endl;
//        std::cout << "run_left:           " << unpack_data->getStm2PcMesg()->stm32_info_data.run_left << std::endl;
//        std::cout << "is_top:             " << unpack_data->getStm2PcMesg()->stm32_info_data.is_top << std::endl;
        std::cout << "电控发pitch               " << pc_send_mesg.robot_pitch << std::endl;
        std::cout << "电控发yaw:                " << pc_send_mesg.robot_yaw << std::endl;
//        std::cout << "pitch_offset:       " << unpack_data->getStm2PcMesg()->stm32_info_data.pitch_offset << std::endl;
//        std::cout << "yaw_offset:         " << unpack_data->getStm2PcMesg()->stm32_info_data.yaw_offset << std::endl;
 //       std::cout << "bullet_spd:         " << unpack_data->getStm2PcMesg()->stm32_info_data.bullet_spd << std::endl;
//#endif

        static int flag, lost_flag;  // 标志，意味着进入自瞄模式第几次成功进入，切换其他模式flag归零

        //-----------------------------------【自瞄模式】--------------------------------------------
        // brief：
        // 1.识别灯条
        // 2.获取所有甲板四个点位置
        // 3.选择最优的甲板（根据得分、滤波、插值或爬波函数）
        // 4.解算角度
        // 5.绘制检测信息与波形
        // 6.串口发送
        //-----------------------------------------------------------------------------------------
        if(main_setting->main_mode == armor_mode)
        {
#ifdef DEBUG_MODE
            armor_setting->setArmorParam(main_setting);
#endif // DEBUG_MODE
            armor.armorDetecProc(src, angle_slover, /*t1,*/ gc, armor, flag, lost_flag/*,a_kalman*/);
            main_setting->main_mode_flag = 0;  // 确保模式更改的时候冲突参数的刷新
        }


#ifdef DEBUG_MODE
        if(main_setting->debug.b_show_dc)
        {
            angle_data.clear();
            angle_data = {/*unpack_data->getStm2PcMesg()->stm32_info_data.pitch * 10*/armor.pit_final * 10, armor.yaw_final * 10};
//            angle_data = {armor.L_v * 2, 0};
            cv::namedWindow("pitch_and_yaw");
            dc.dataCollectProc(angle_data, color_list, "pitch_and_yaw");
        }
        else
        {
            if(-1 != cv::getWindowProperty("pitch_and_yaw", 1))
                cv::destroyWindow("pitch_and_yaw");
        }
#endif // DEBUG_MODE

#ifdef DEBUG_MODE
        main_setting->debug.n_key_order = cv::waitKey(1);
        if(tolower(main_setting->debug.n_key_order) == KEY_SAVE_PARAM)
        {
            main_setting->writeOtherParam(PARAM_OTHER_PATH);
            if(main_setting->main_mode == armor_mode)
                armor_setting->writeArmorParam(PARAM_ARMOR_PATH);
        }
        t2 = ((double)cv::getTickCount() - t2) / cv::getTickFrequency();
        armor.fps = 1.0 / t2;
        if(main_setting->debug.b_show_fps)
            std::cout << "FPS:       " << armor.fps << std::endl;
#if (USE_VIDEO == 1)
        cv::waitKey(33);
#endif // USE_VIDEO
#else // DEBUG_MODE
        cv::waitKey(1);
#endif // DEBUG_MODE
        if(main_setting->debug.b_save_result == true)
        {
            vw_src << src;
            if(main_setting->debug.n_key_order == KEY_SAVE_RESULT)
                vw_src.release();
        }
    }

#if (USE_VIDEO == 0)
    MVVideoCapture::Stop();
    MVVideoCapture::Uninit();
#endif  // USE_VIDEO
}
